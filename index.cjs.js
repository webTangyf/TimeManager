"use strict";var TypeError=function(t){return Error('"'+t+'"参数类型错误')},ENVError=function(){return Error("当persisted为true时，TimeManager仅支持浏览器环境运行")},StartAfterSet=function(){return Error("请先调用set方法后，再启用倒计时")},AddAfterSet=function(){return Error("请先调用set方法后，再增加时间间隔")},ReduceAfterSet=function(){return Error("请先调用set方法后，再减少时间间隔")},runAnyAfterDestory=function(){return Error("销毁后，请不要在使用当前计时器的任何方法")},GapWarn=function(){return console.warn("时间间隔不得小于零")},GapReduceWarn=function(){return console.warn("reduce后的时间间隔不得小于零")},hasStartedWarn=function(t){return console.warn(t+": 已经开始计时")},hasStopedWarn=function(t){return console.warn(t+": 已经开始计时")},isNoValue=function(t){return["",void 0,null].includes(t)},isPlainObj=function(t){return"object"===getType(t)},isString=function(t){return"string"===getType(t)},isNumber=function(t){return"number"===getType(t)},isDomexcEption=function(t){return"domexception"===getType(t)},getType=function(t){return Object.prototype.toString.call(t).replace(/\[object|\]|\s/g,"").toLowerCase()},getTimeStamp=function(){return""+(new Date).getTime()},esayCover=function(r,s){if(!isPlainObj(r)||!isPlainObj(s))throw Error("esayCover函数的入参数仅接受plainObj");return Object.keys(r).reduce(function(t,e){return t[e]=isNoValue(s[e])&&r[e]||s[e],t},{})},isBrowser=function(){return!isNoValue(window)},SECUND=1e3,MIN=60*SECUND,HOUR=60*MIN,DAY=24*HOUR,MONTH=30*DAY,YEAR=365*DAY,DATE=Object.freeze({__proto__:null,SECUND:SECUND,MIN:MIN,HOUR:HOUR,DAY:DAY,MONTH:MONTH,YEAR:YEAR}),INIT="INIT",RUNNING="RUNNING",STOP="STOP",END="END",defaultOption={DEBUG:!1,STEP:SECUND,persisted:!0},_getStorage=function(){return window[TimeManager.OPTION.DEFAULT_METHOD]},_setTimeStorage=function(e){var r=this;Object.keys(e).forEach(function(t){r._storage_[t]=e[t]})},_getLastGap=function(){return parseInt((this._storage_.targetTimestamp-(new Date).getTime())/this._opt_.STEP)},_isEnd=function(){return this._getLastGap()<=0},_init=function(){var t=this._storage_[0<arguments.length&&void 0!==arguments[0]&&arguments[0]?"stopGap":"gap"]*this._opt_.STEP,e=(new Date).getTime();this._storage_.beginTimestamp=e,this._storage_.targetTimestamp=e+t,this._storage_.status=RUNNING},_run=function(){var t=this;this._storage_.status===RUNNING&&(this._timer=setTimeout(function(){t._isEnd()?t.end():(t._stepCallBack&&t._stepCallBack(t._storage_),t._run())},this._opt_.STEP))},_getStorageKeys=function(){for(var t=0,e=_getStorage(),r=e.key(t),s=[];isString(r);)s.push(r),r=e.key(++t);return s.filter(function(t){return 0==t.indexOf(TimeManager.OPTION.DEFAULT_PREFIX)})},_isOverStorage=function(t){if(isDomexcEption(t))return t.message.includes("exceeded")},_save2Storage=function(e){var r=_getStorage();try{r[""+TimeManager.OPTION.DEFAULT_PREFIX+e.name]=JSON.stringify(e)}catch(t){if(_isOverStorage(t)){r=_getStorageKeys();if(0<r.length){var s=_getStorage();r.forEach(function(t){JSON.parse(s[t]).status===END&&s.removeItem(t)});try{s[""+TimeManager.OPTION.DEFAULT_PREFIX+e.name]=JSON.stringify(e)}catch(t){console.warn(t)}}}console.warn(t)}},_setProxy=function(){var a=this;this._storage_=new Proxy(this._storage_,{set:function(t,e,r,s){s=Reflect.set(t,e,r,s);return a._save2Storage(t),a._opt_.DEBUG&&console.log("proxy:",t.name,e,r),s}})},set=function(t){if(!isNumber(t))throw TypeError("gap");return t<0&&(GapWarn(),t=0),this._storage_.gap=t,this},add=function(t){if(!isNumber(t))throw TypeError("gap");if(!isNumber(this._storage_.gap))throw AddAfterSet();if(t<=0)return GapWarn(),this;var e=this._storage_.status;return e===RUNNING&&(this._storage_.targetTimestamp+=t*this._opt_.STEP,this._storage_.gap+=t),[INIT,STOP,END].includes(e)&&(this._storage_.gap+=t),this},reduce=function(t){if(!isNumber(t))throw TypeError("gap");if(!isNumber(this._storage_.gap))throw ReduceAfterSet();if(t<=0)return GapWarn(),this;var e=this._storage_.status;return e===RUNNING&&(this._storage_.targetTimestamp-=t*this._opt_.STEP,this._storage_.gap-=t,this._isEnd())?this.end():([INIT,STOP,END].includes(e)&&(this._storage_.gap-=t,this._storage_.gap<0&&(GapReduceWarn(),this._storage_.gap=0)),this)},start=function(){var r=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this._storage_.status===RUNNING)return hasStartedWarn(this._storage_.name),this;if(!isNumber(this._storage_.gap))throw StartAfterSet();var e=t.stepCallBack,t=t.endCallBack;return t&&(this._endCallBack=t),this._stepCallBack=e,this._init(),this._run(),t?this:new Promise(function(t,e){r._endCallBack=t})},reStart=function(){var r=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],s=this._storage_.status,a=t.stepCallBack,n=t.endCallback;return s===STOP?(this._init(!0),this._storage_.stopGap=null,setTimeout(function(){r._isEnd()&&r.end(),r._run()}),!e||(this._stepCallBack=a,this.endCallback=n)?this:new Promise(function(t,e){r._endCallBack=t})):(n&&(this._endCallBack=n),this._stepCallBack=a,s===INIT?this.start(t):s===RUNNING?(setTimeout(function(){r._isEnd()&&r.end(),r._run()}),this):new Promise(function(t,e){r._endCallBack=t}))},stop=function(){return this._storage_.status===STOP?hasStopedWarn(this._storage_.name):this._isEnd()?this.end():(clearTimeout(this._timer),this._storage_.stopGap=this._getLastGap(),this._storage_.status=STOP,this._storage_.beginTimestamp=null,this._storage_.targetTimestamp=null),this},end=function(){return this._timer=null,this._storage_.status=END,this._endCallBack&&this._endCallBack(this._storage_),this._endCallBack=null,this._stepCallBack=null,this.reset()},destory=function(){var e=this;this._storage_.status===RUNNING&&this.end(),TimeManager.names=TimeManager.names.filter(function(t){return t!==e._storage_.name}),_getStorage().removeItem(this._storage_.name),this._storage_=null,this._opt_=null,this._endCallBack=null,this._stepCallBack=null,Object.keys(TimeManager.prototype).forEach(function(t){e[t]=function(){throw runAnyAfterDestory}})},reset=function(){return this._storage_.gap=0,this._storage_.stopGap=null,this._storage_.beginTimestamp=null,this._storage_.targetTimestamp=null,this},getStatus=function(){return this._storage_.status},getGap=function(){return this._storage_.gap},reStarts=function(){var t=_getStorageKeys();if(0===t.length)return{};var s={};return t.forEach(function(t){try{var e=JSON.parse(_getStorage()[t]);console.log(e);var r=new TimeManager(e.option);r._setTimeStorage(e),s[t]=r}catch(t){console.log(t)}}),s},TimeManager=function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{persisted:!0};if(this._opt_=esayCover(defaultOption,e),!isBrowser()&&this._opt_.persisted)throw ENVError();if(this._opt_.DEBUG&&console.log(this._opt_),this._storage_={name:e.name||""+getTimeStamp(),beginTimestamp:null,targetTimestamp:null,gap:null,stopGap:null,status:INIT,option:this._opt_},t.names.includes(this._storage_.name))throw Error(this._storage_.name+"已经存在");t.names.push(this._storage_.name),this._opt_.persisted&&this._setProxy()};TimeManager.OPTION={DEFAULT_METHOD:"sessionStorage",DEFAULT_PREFIX:"__TIME_MANAGER__"},TimeManager.DATE=DATE,TimeManager._getStorage=_getStorage,TimeManager.reStarts=reStarts,TimeManager.names=[],TimeManager.prototype={set:set,add:add,reduce:reduce,start:start,stop:stop,end:end,reset:reset,destory:destory,reStart:reStart,getStatus:getStatus,getGap:getGap,_init:_init,_isEnd:_isEnd,_run:_run,_setProxy:_setProxy,_setTimeStorage:_setTimeStorage,_getLastGap:_getLastGap,_isOverStorage:_isOverStorage,_save2Storage:_save2Storage},module.exports=TimeManager;
