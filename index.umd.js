!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).TimeManager=e()}(this,function(){"use strict";function s(t){return Error('"'+t+'"参数类型错误')}function n(){return Error("销毁后，请不要在使用当前计时器的任何方法")}function r(){return console.warn("时间间隔不得小于零")}function i(t){return["",void 0,null].includes(t)}function a(t){return"object"===l(t)}function o(t){return"number"===l(t)}function _(){return window[d.OPTION.DEFAULT_METHOD]}function u(){for(var t=0,e=_(),s=e.key(t),n=[];"string"===l(s);)n.push(s),s=e.key(++t);return n.filter(function(t){return 0==t.indexOf(d.OPTION.DEFAULT_PREFIX)})}function h(t){var e;if(e=t,"domexception"===l(e))return t.message.includes("exceeded")}var l=function(t){return Object.prototype.toString.call(t).replace(/\[object|\]|\s/g,"").toLowerCase()},t=864e5,t=Object.freeze({__proto__:null,SECUND:1e3,MIN:6e4,HOUR:36e5,DAY:t,MONTH:2592e6,YEAR:31536e6}),c="INIT",g="RUNNING",p="STOP",f="END",m={DEBUG:!1,STEP:1e3,persisted:!0},d=function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{persisted:!0};if(this._opt_=function(s,n){if(!a(s)||!a(n))throw Error("esayCover函数的入参数仅接受plainObj");return Object.keys(s).reduce(function(t,e){return t[e]=i(n[e])&&s[e]||n[e],t},{})}(m,e),i(window)&&this._opt_.persisted)throw Error("当persisted为true时，TimeManager仅支持浏览器环境运行");if(this._opt_.DEBUG&&console.log(this._opt_),this._storage_={name:e.name||""+(new Date).getTime(),beginTimestamp:null,targetTimestamp:null,gap:null,stopGap:null,status:c,option:this._opt_},t.names.includes(this._storage_.name))throw Error(this._storage_.name+"已经存在");t.names.push(this._storage_.name),this._opt_.persisted&&this._setProxy()};return d.OPTION={DEFAULT_METHOD:"sessionStorage",DEFAULT_PREFIX:"__TIME_MANAGER__"},d.DATE=t,d._getStorage=_,d.reStarts=function(){var t=u();if(0===t.length)return{};var n={};return t.forEach(function(t){try{var e=JSON.parse(_()[t]);console.log(e);var s=new d(e.option);s._setTimeStorage(e),n[t]=s}catch(t){console.log(t)}}),n},d.names=[],d.prototype={set:function(t){if(!o(t))throw s("gap");return t<0&&(r(),t=0),this._storage_.gap=t,this},add:function(t){if(!o(t))throw s("gap");if(!o(this._storage_.gap))throw Error("请先调用set方法后，再增加时间间隔");if(t<=0)return r(),this;var e=this._storage_.status;return e===g&&(this._storage_.targetTimestamp+=t*this._opt_.STEP,this._storage_.gap+=t),[c,p,f].includes(e)&&(this._storage_.gap+=t),this},reduce:function(t){if(!o(t))throw s("gap");if(!o(this._storage_.gap))throw Error("请先调用set方法后，再减少时间间隔");if(t<=0)return r(),this;var e=this._storage_.status;return e===g&&(this._storage_.targetTimestamp-=t*this._opt_.STEP,this._storage_.gap-=t,this._isEnd())?this.end():([c,p,f].includes(e)&&(this._storage_.gap-=t,this._storage_.gap<0&&(console.warn("reduce后的时间间隔不得小于零"),this._storage_.gap=0)),this)},start:function(){var s=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this._storage_.status===g)return console.warn(this._storage_.name+": 已经开始计时"),this;if(!o(this._storage_.gap))throw Error("请先调用set方法后，再启用倒计时");var e=t.stepCallBack,t=t.endCallBack;return t&&(this._endCallBack=t),this._stepCallBack=e,this._init(),this._run(),t?this:new Promise(function(t,e){s._endCallBack=t})},stop:function(){return this._storage_.status===p?console.warn(this._storage_.name+": 已经开始计时"):this._isEnd()?this.end():(clearTimeout(this._timer),this._storage_.stopGap=this._getLastGap(),this._storage_.status=p,this._storage_.beginTimestamp=null,this._storage_.targetTimestamp=null),this},end:function(){return this._timer=null,this._storage_.status=f,this._endCallBack&&this._endCallBack(this._storage_),this._endCallBack=null,this._stepCallBack=null,this.reset()},reset:function(){return this._storage_.gap=0,this._storage_.stopGap=null,this._storage_.beginTimestamp=null,this._storage_.targetTimestamp=null,this},destory:function(){var e=this;this._storage_.status===g&&this.end(),d.names=d.names.filter(function(t){return t!==e._storage_.name}),_().removeItem(this._storage_.name),this._storage_=null,this._opt_=null,this._endCallBack=null,this._stepCallBack=null,Object.keys(d.prototype).forEach(function(t){e[t]=function(){throw n}})},reStart:function(){var s=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],n=this._storage_.status,r=t.stepCallBack,i=t.endCallback;return n===p?(this._init(!0),this._storage_.stopGap=null,setTimeout(function(){s._isEnd()&&s.end(),s._run()}),!e||(this._stepCallBack=r,this.endCallback=i)?this:new Promise(function(t,e){s._endCallBack=t})):(i&&(this._endCallBack=i),this._stepCallBack=r,n===c?this.start(t):n===g?(setTimeout(function(){s._isEnd()&&s.end(),s._run()}),this):new Promise(function(t,e){s._endCallBack=t}))},getStatus:function(){return this._storage_.status},getGap:function(){return this._storage_.gap},_init:function(){var t=this._storage_[0<arguments.length&&void 0!==arguments[0]&&arguments[0]?"stopGap":"gap"]*this._opt_.STEP,e=(new Date).getTime();this._storage_.beginTimestamp=e,this._storage_.targetTimestamp=e+t,this._storage_.status=g},_isEnd:function(){return this._getLastGap()<=0},_run:function(){var t=this;this._storage_.status===g&&(this._timer=setTimeout(function(){t._isEnd()?t.end():(t._stepCallBack&&t._stepCallBack(t._storage_),t._run())},this._opt_.STEP))},_setProxy:function(){var r=this;this._storage_=new Proxy(this._storage_,{set:function(t,e,s,n){n=Reflect.set(t,e,s,n);return r._save2Storage(t),r._opt_.DEBUG&&console.log("proxy:",t.name,e,s),n}})},_setTimeStorage:function(e){var s=this;Object.keys(e).forEach(function(t){s._storage_[t]=e[t]})},_getLastGap:function(){return parseInt((this._storage_.targetTimestamp-(new Date).getTime())/this._opt_.STEP)},_isOverStorage:h,_save2Storage:function(e){var s=_();try{s[""+d.OPTION.DEFAULT_PREFIX+e.name]=JSON.stringify(e)}catch(t){if(h(t)){s=u();if(0<s.length){var n=_();s.forEach(function(t){JSON.parse(n[t]).status===f&&n.removeItem(t)});try{n[""+d.OPTION.DEFAULT_PREFIX+e.name]=JSON.stringify(e)}catch(t){console.warn(t)}}}console.warn(t)}}},d});
